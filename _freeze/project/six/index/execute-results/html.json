{
  "hash": "20d47a86143fb9607b79a25bbbe9009f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Six Months Later\"\ndate: \"2018-04-02\"\ncategories: [R]\ndescription: \"Exploring colour palettes and small multiples using cloud services spend data\"\nbibliography: references.bib\n---\n\n\n![](feature.gif){fig-alt=\"A silhouette of the Houses of Parliament and three clouds in Spring colours, e.g. yellow and green. Flowers shoot up from the word \\\"Spring\\\".\"}\n\nIn September 2017 I wrote a post entitled [Let's Jitter](/project/jitter). It looked at how the SME share of sales evolved over time. I revisited this topic here six months later, along the way adding a splash of colour and some faceted plots.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(conflicted)\nlibrary(tidyverse)\nconflict_prefer_all(\"dplyr\", quiet = TRUE)\nlibrary(clock)\nlibrary(scales)\nlibrary(ggfoundry)\nlibrary(paletteer)\nlibrary(usedthese)\n\nconflict_scout()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_bw())\n\nn <- 9\npal_name <- \"wesanderson::Chevalier1\"\n\npal <- paletteer_d(pal_name)\npal <- colorRampPalette(pal)(n)\n\ndisplay_palette(\n  fill = pal, n = n, pal_name = pal_name, \n  shape = \"tube\", shape_size = 0.9, label_size = 2\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/theme-1.png){width=100%}\n:::\n:::\n\n\nIn [Let's Jitter](/project/jitter) I assumed the G-Cloud data file adopted the [UK Government standard](https://www.gov.uk/guidance/gds-api-technical-and-data-standards#use-unicode-for-encoding) of UTF-8. I used the stringr package to fix any issues.\n\nThis time around, I'm importing the files for two frameworks (G-Cloud and DOS) after first checking the encoding to see if I can get a cleaner import. `guess_encoding` suggests these files use the ISO-8859-1 standard.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \n  \"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/\"\n\ngcloud_csv <- str_c(url, \"678283/G-Cloud-spend-Dec2017.csv\")\n\ndos_csv <- str_c(url, \"678286/DOS-spend-Dec2017.csv\")\n\nnames <- c(gcloud_csv, dos_csv)\n\nmap(names, guess_encoding)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n# A tibble: 2 × 2\n  encoding   confidence\n  <chr>           <dbl>\n1 ISO-8859-1       0.39\n2 ISO-8859-2       0.24\n\n[[2]]\n# A tibble: 2 × 2\n  encoding   confidence\n  <chr>           <dbl>\n1 ISO-8859-1       0.44\n2 ISO-8859-2       0.23\n```\n\n\n:::\n:::\n\n\nNext I'll set up a vector of column names to apply consistently to both files, import the data with the suggested encoding, and bind them into one tibble.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnam <-\n  c(\"sector\",\n    \"lot\",\n    \"month\",\n    \"spend\",\n    \"status\",\n    \"supplier\",\n    \"customer\",\n    \"framework\")\n\nread_dm <- \\(x){\n  read_csv(\n    x,\n    col_names = colnam,\n    skip = 1,\n    locale = locale(encoding = \"ISO-8859-1\"),\n    col_types = NULL,\n    show_col_types = FALSE)\n}\n\ncombined_df <- map(names, read_dm) |> \n  set_names(c(\"gcloud\", \"dos\")) |> \n  bind_rows() |> \n  mutate(framework = if_else(is.na(framework), \"DOS\", framework))\n```\n:::\n\n\nI'd like to create some new features: Month-end dates, something to distinguish between the two frameworks (*G-Cloud* or *DOS*) and the framework version (i.e. G-Cloud 1 to 9). The spend has a messy format and needs a bit of cleaning too.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclean_df <- combined_df |>\n  mutate(\n    month_end = date_parse(str_c(month, \"01\", sep = \"-\"), \n                           format = \"%b-%y-%d\") |> \n      add_months(1) |> add_days(-1),\n    version = str_remove(framework, fixed(\"-Cloud \")),\n    version = str_replace(version, fixed(\"G-Cloud\"), \"G1\"),\n    version = str_replace(version, fixed(\"GIII\"), \"G3\"),\n    version = str_replace(version, fixed(\"GServices II\"), \"G2\"),\n    framework = str_extract(framework, \".{3,7}\"),\n    spend = str_remove(spend, fixed(\"£\")),\n    spend = str_replace(spend, \"^\\\\(\", \"-\"),\n    spend = parse_number(spend),\n    SME_spend = if_else(status == \"SME\", spend, 0)\n  )\n```\n:::\n\n\nFinding the interval between G-Cloud versions will enable me to calculate and print the average in the next paragraph using inline r code.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nversion_df <- clean_df |>\n  filter(version != \"DOS\") |> \n  summarise(start = min(month_end), .by = version) |> \n  mutate(next_start = lead(start),\n         interval = lubridate::interval(start, next_start) %/% months(1))\n```\n:::\n\n\nEvery 7.8 months, on average, suppliers are asked to resubmit their G-Cloud offerings with their latest pricing and service descriptions. It's a chance for new suppliers, often smaller ones, to join the existing list of suppliers and increase overall competitiveness for Cloud services.\n\nLet's visualise how each of these framework versions grows, matures and fades away as the next one takes over.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvers_summary <- clean_df |>\n  filter(version != \"DOS\") |> \n  summarise(sales = sum(spend) / 1000000,\n            .by = c(version, month_end))\n\nvers_summary |> \n  ggplot(aes(month_end, sales, colour = version)) +\n  geom_line() +\n  geom_smooth() +\n  scale_x_date(date_breaks = \"years\", date_labels = \"%Y\") +\n  scale_y_continuous(labels = label_dollar(prefix = \"£\", suffix = \"m\")) +\n  scale_colour_manual(values = pal) +\n  labs(x = NULL, y = NULL, title = \"The Lifecycle of G-Cloud Versions\", \n       subtitle = \"Monthly Sales by Version\") + \n  labs(caption = \"\\nSource: GOV.UK's Digital Marketplace\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/lifecycle-1.png){width=100%}\n:::\n:::\n\n\n[Let's Jitter](/project/jitter) showed signs of a weakening in the SME share of G-Cloud sales by value. This plot shows this trend to have persisted, and also reflects the Digital Outcomes & Specialists (DOS) framework exhibiting a downward trend.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfw_summary <- clean_df |>\n  summarise(pct = sum(SME_spend, na.rm = TRUE) / sum(spend, na.rm = TRUE),\n            .by = c(framework, month_end))\n\nfw_summary |> \n  ggplot(aes(month_end, pct, colour = framework)) +\n  geom_line() +\n  geom_smooth() +\n  scale_y_continuous(breaks = c(0.25, 0.5, 0.75, 1), labels = label_percent()) +\n  scale_x_date(date_breaks = \"years\", date_labels = \"%Y\") +\n  scale_colour_manual(values = pal[c(1, 9)]) +\n  labs(x = NULL, y = NULL, \n       title = \"The Waning SME Share of Sales\", \n       subtitle = \"% Monthly Sales Value via SME (vs Large Enterprise) Suppliers\") + \n  labs(caption = \"\\nSource: GOV.UK's Digital Marketplace\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/trend-1.png){width=100%}\n:::\n:::\n\n\nOverall spending via the combined frameworks however continues to grow across all parts of Public Sector. I'll use a [small multiples](https://en.wikipedia.org/wiki/Small_multiple) visualisation technique to show this using ggplot2's[@ggplot2] `facet_wrap`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsect_summary <-\n  clean_df |>\n  filter(!sector %in% c(\n    \"Unregistered or Unknown\",\n    \"Utility (Historic)\",\n    \"Wider Public Sector\"\n  )) |>\n  summarise(\n    sales = sum(spend) / 1000000,\n    pct = sum(SME_spend, na.rm = TRUE) / sum(spend, na.rm = TRUE),\n    .by = c(sector, month_end)\n  )\n\nsect_summary |> \n  ggplot(aes(month_end, sales, colour = sector)) +\n  geom_line() +\n  geom_smooth() +\n  facet_wrap(~ sector, scales = \"free_y\") +\n  theme(legend.position = \"none\") +\n  scale_x_date(date_breaks = \"years\", date_labels = \"%Y\") +\n  scale_y_continuous(labels = label_dollar(prefix = \"£\", suffix = \"m\")) +\n  scale_colour_manual(values = pal) +\n  labs(x = NULL, y = NULL, \n       title = \"All Sectors Increase Digital Marketplace Spend\", \n       subtitle = \"G-Cloud & DOS Spend by Sector\") + \n  labs(caption = \"\\nSource: GOV.UK's Digital Marketplace\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/multiples-1.png){width=100%}\n:::\n:::\n\n\nThe decline in the proportion of spend via SMEs is also fairly broad-based.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsect_summary |> \n  ggplot(aes(month_end, pct, colour = sector)) +\n  geom_line() +\n  geom_smooth() +\n  facet_wrap(~ sector, scales = \"free_y\") +\n  theme(legend.position = \"none\") +\n  scale_x_date(date_breaks = \"years\", date_labels = \"%Y\") +\n  scale_y_continuous(labels = label_percent()) +\n  scale_colour_manual(values = pal) +\n  labs(x = NULL, y = NULL, \n       title = \"Most Sectors Spend Proportionately Less on SMEs\", \n       subtitle = \"Pct SME G-Cloud & DOS Spend by Sector\") + \n  labs(caption = \"\\nSource: GOV.UK's Digital Marketplace\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/proportion-1.png){width=100%}\n:::\n:::\n\n\n## R Toolbox\n\nSummarising below the packages and functions used in this post enables me to separately create a [toolbox visualisation](/project/box) summarising the usage of packages and functions across all posts.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nused_here()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"usedthese table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Package </th>\n   <th style=\"text-align:left;\"> Function </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> base </td>\n   <td style=\"text-align:left;\"> c[9], is.na[1], library[7], min[1], months[1], sum[6] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> clock </td>\n   <td style=\"text-align:left;\"> add_days[1], add_months[1], date_parse[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> conflicted </td>\n   <td style=\"text-align:left;\"> conflict_prefer_all[1], conflict_scout[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dplyr </td>\n   <td style=\"text-align:left;\"> bind_rows[1], filter[3], if_else[2], lead[1], mutate[3], summarise[4] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ggfoundry </td>\n   <td style=\"text-align:left;\"> display_palette[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ggplot2 </td>\n   <td style=\"text-align:left;\"> aes[4], facet_wrap[2], geom_line[4], geom_smooth[4], ggplot[4], labs[8], scale_colour_manual[4], scale_x_date[4], scale_y_continuous[4], theme[2], theme_bw[1], theme_set[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> grDevices </td>\n   <td style=\"text-align:left;\"> colorRampPalette[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> lubridate </td>\n   <td style=\"text-align:left;\"> interval[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> paletteer </td>\n   <td style=\"text-align:left;\"> paletteer_d[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> purrr </td>\n   <td style=\"text-align:left;\"> map[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> readr </td>\n   <td style=\"text-align:left;\"> locale[1], parse_number[1], read_csv[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> rlang </td>\n   <td style=\"text-align:left;\"> set_names[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> scales </td>\n   <td style=\"text-align:left;\"> label_dollar[2], label_percent[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> stringr </td>\n   <td style=\"text-align:left;\"> fixed[5], str_c[3], str_extract[1], str_remove[2], str_replace[4] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> usedthese </td>\n   <td style=\"text-align:left;\"> used_here[1] </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}