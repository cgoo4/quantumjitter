{
  "hash": "c9734111ae7fd4400b49ebe49c894d1f",
  "result": {
    "markdown": "---\ntitle: \"Can Ravens Forecast?\"\ndate: \"2018-07-29\"\ncategories: [R, time series, forecast]\ndescription: \"Time series forecasting using cloud services spend data\"\nbibliography: references.bib\n---\n\n\n![](feature.gif){fig-alt=\"A silhouette of the Houses of Parliament with rain pouring down on a man holding an umbrella and a raven swooping across the sky\"}\n\nHumans have the magical ability to plan for future events, for future gain. It's [not quite a uniquely human trait](https://www.newscientist.com/article/2140668-ravens-can-plan-for-future-as-well-as-4-year-old-children-can/). Because apparently ravens can match a four-year-old.\n\nAn abundance of data, and some very nice R packages, make our ability to plan all the more powerful.\n\nIn the Spring of 2018 I looked at sales from an historical perspective in [Six Months Later.](/project/six). Here I'll use the data to model a time-series forecast for the year ahead. The techniques apply to any time series with characteristics of trend, seasonality or longer-term cycles.\n\nWhy forecast sales? Business plans require a budget, e.g. for resources, marketing and office space. A good projection of revenue provides the foundation for the budget. And, for an established business, with historical data, time-series forecasting is one way to deliver a robust projection.\n\nWithout exogenous data, the forecast assumes one continues to do what one's doing. So, it provides a good starting-point. Then one might, for example, add assumptions about new products or services. And, if there is forward-looking data available, for example, market size projections (with past projections to train the model), then one could feed this into the forecast modelling too.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(conflicted)\nlibrary(tidyverse)\nconflict_prefer_all(\"dplyr\")\nlibrary(wesanderson)\nlibrary(fpp3)\nlibrary(scales)\nlibrary(clock)\nlibrary(usedthese)\n\nconflict_scout()\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n7 conflicts:\n* `as_date`    : clock, lubridate\n* `col_factor` : scales, readr\n* `date_format`: clock, scales\n* `discard`    : scales, purrr\n* `filter`     : [dplyr]\n* `interval`   : tsibble, lubridate\n* `lag`        : [dplyr]\n```\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_bw())\n\n(cols <- wes_palette(name = \"IsleofDogs2\"))\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/theme-1.png){width=100%}\n:::\n:::\n\n\nFirst I'll check the encoding of the data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <-\n  \"https://www.gov.uk/government/uploads/system/uploads/attachment_data/file/\"\n\ngcloud_csv <- str_c(url, \"703943/G-Cloud_spend_data_to_end_March_2018.csv\")\n\ndos_csv <- str_c(url, \"703952/DOS_spend_data_to_end_March_2018.csv\")\n\nnames <- c(gcloud_csv, dos_csv)\n\n# Use walk to suppress the printing of list element numbers\n\nwalk(names, \\(x) {\n  p <- guess_encoding(x)\n  print(p)\n})\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2 × 2\n  encoding   confidence\n  <chr>           <dbl>\n1 ISO-8859-1       0.4 \n2 ISO-8859-2       0.22\n# A tibble: 2 × 2\n  encoding   confidence\n  <chr>           <dbl>\n1 ISO-8859-1       0.36\n2 ISO-8859-2       0.24\n```\n:::\n:::\n\n\nNext I'll set up a vector of column names to apply consistently to both files, and import the data with the suggested encoding.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolnam <- \n  c(\"sector\",\n    \"lot\",\n    \"date\",\n    \"spend\",\n    \"status\",\n    \"supplier\",\n    \"customer\",\n    \"framework\")\n\nread_dm <- \\(x){\n  read_csv(\n    x,\n    col_names = colnam,\n    skip = 1,\n    locale = locale(encoding = \"ISO-8859-1\"),\n    show_col_types = FALSE)\n}\n\nraw <- map(names, read_dm) |> \n  set_names(c(\"gcloud\", \"dos\")) |> \n  bind_rows() |> \n  mutate(framework = if_else(is.na(framework), \"DOS\", framework))\n```\n:::\n\n\nI'd like to create some new features: Month-end dates, something to distinguish between the two frameworks (*G-Cloud* or *DOS*). The spend has a messy format and needs a bit of cleaning too.\n\nThe lot structure for *G-Cloud* has evolved over time, but fortunately, there is a simple mapping, i.e. *PaaS* and *IaaS* became *Cloud Hosting*, *SaaS* became *Cloud Software*, and *Specialist Cloud Services* became *Cloud Support*, so I'll standardise on the latter.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboth <- raw |>\n  mutate(\n    month_end = date_parse(str_c(date, \"01\", sep = \"-\"), \n                           format = \"%b-%y-%d\") |> \n      add_months(1) |> add_days(-1),\n    date = yearmonth(month_end),\n    framework = str_extract(framework, \".{3,7}\"),\n    spend = str_remove(spend, coll(\"£\")),\n    spend = str_replace(spend, \"^\\\\(\", \"-\"),\n    spend = parse_number(spend) / 1000000,\n    lot = recode(\n      lot,\n      \"Software as a Service (SaaS)\" = \"Cloud Software\",\n      \"Infrastructure as a Service (IaaS)\" = \"Cloud Hosting\",\n      \"Platform as a Service (PaaS)\" = \"Cloud Hosting\",\n      \"Specialist Cloud Services\" = \"Cloud Support\"\n      )\n)\n```\n:::\n\n\nThe tidied data now needs to be converted to a [tsibble](https://github.com/tidyverts/tsibble)[@tsibble], the temporal equivalent of a [tibble](https://tibble.tidyverse.org)[@tibble].\n\nR has evolved since I first wrote this post. At that time, it was necessary to either split the data into the two frameworks (G-Cloud and DOS) and forecast them separately. Or, as I did with the three G-Cloud lots, use the purrr package to iterate through a forecast.\n\nThe tsibble package combined with the newer fable[@fable] and feasts[@feasts] packages, make this easier. One of the defining feature of the tsibble is the `key`. I want a model for each framework, so I'm setting this as the tsibble `key` (and the temporal variable as the tsibble `index`).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboth_ts <- both |>\n  summarise(spend = sum(spend), .by = c(date, framework)) |> \n  as_tsibble(key = framework, index = date)\n\nboth_ts |> \n  ggplot(aes(date, spend, colour = framework)) +\n  geom_line(key_glyph = \"timeseries\") +\n  scale_y_continuous(labels = label_dollar(prefix = \"£\", suffix = \"m\")) +\n  scale_colour_manual(values = cols[c(3, 4)]) +\n  labs(x = NULL, y = NULL, title = \"Monthly Digital Marketplace Sales\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/plot sales-1.png){width=100%}\n:::\n:::\n\n\nBy decomposing the historical data we can tease out the underlying trend and seasonality:\n\n-   **Trend**: The sales for both frameworks have grown over time as more Suppliers have added their services to the Government frameworks, and more Public Sector organizations have found the benefits of purchasing Cloud services through this faster, simpler, more transparent and more competitive contracting vehicle.\n\n-   **Seasonality**: Suppliers often manage their sales and financials based on a quarterly cycle, with a particular emphasis on a strong close to the financial year. And Government Buyers may want to make optimal use of their budgets at the close of their financial year (March 31st). Consequently, we see quarterly seasonality with an extra spike at financial year-end.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboth_ts |>\n  model(stl = STL(spend ~ trend(window = 7) + season(window = \"periodic\"))) |>\n  components() |>\n  autoplot() +\n  scale_colour_manual(values = cols[c(3, 4)]) +\n  labs(x = NULL, title = \"Time Series Decomposition\")\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/decomposition-1.png){width=100%}\n:::\n:::\n\n\nI'll use `auto.arima`: [AutoRegressive Integrated Moving Average](https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average) modelling which aims to describe the autocorrelations in the data.\n\nBy setting `stepwise` and `approximation` to `FALSE`, `auto.arima` will explore a wider range of potential models.\n\nI'll forecast with the default 80% and 95% prediction intervals. This means the darker-shaded 80% range should include the future sales value with an 80% probability. Likewise with a 95% probability when adding the wider and lighter-shaded area.\n\nUse of `autoplot` would simplify the code, but personally I like to expose all the data, for example unpacking the prediction intervals, and have finer control over the visualisation.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod_ts <- both_ts |>\n  model(ARIMA = ARIMA(spend, stepwise = TRUE, approximation = FALSE))\n\nmod_ts |> \n  glance() |>\n  select(-ar_roots, -ma_roots)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|framework |.model |   sigma2|    log_lik|      AIC|     AICc|      BIC|\n|:---------|:------|--------:|----------:|--------:|--------:|--------:|\n|DOS       |ARIMA  | 23.60154|  -59.93305| 123.8661| 124.5720| 125.8576|\n|G-Cloud   |ARIMA  | 34.75275| -191.61547| 393.2309| 394.3421| 403.7027|\n\n</div>\n:::\n\n```{.r .cell-code}\nmod_ts |> \n  tidy()\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|framework |.model |term     |   estimate| std.error| statistic|   p.value|\n|:---------|:------|:--------|----------:|---------:|---------:|---------:|\n|DOS       |ARIMA  |ma1      | -0.7725018| 0.1718541| -4.495102| 0.0002213|\n|G-Cloud   |ARIMA  |ar1      |  0.9390150| 0.0595354| 15.772391| 0.0000000|\n|G-Cloud   |ARIMA  |ma1      | -0.5777210| 0.1094066| -5.280494| 0.0000019|\n|G-Cloud   |ARIMA  |sar1     | -0.5124417| 0.1142670| -4.484597| 0.0000336|\n|G-Cloud   |ARIMA  |constant |  1.4084703| 0.3168155|  4.445712| 0.0000385|\n\n</div>\n:::\n\n```{.r .cell-code}\nfcast_ts <- mod_ts |>\n  forecast(h = \"2 years\") |> \n  mutate(`95%` = hilo(spend, 95), `80%` = hilo(spend, 80)) |> \n  unpack_hilo(c(\"95%\", \"80%\")) |>\n  rename(fc_spend = spend) |> \n  bind_rows(both_ts)\n\nfcast_ts |>\n  ggplot(aes(date, fill = framework)) +\n  geom_line(aes(y = spend), colour = cols[5]) +\n  geom_ribbon(aes(ymin = `95%_lower`, ymax = `95%_upper`),\n    fill = cols[1], colour = NA\n  ) +\n  geom_ribbon(aes(ymin = `80%_lower`, ymax = `80%_upper`),\n    fill = cols[2], colour = NA\n  ) +\n  geom_line(aes(y = .mean), colour = \"white\") +\n  scale_y_continuous(labels = label_dollar(prefix = \"£\", suffix = \"m\")) +\n  facet_wrap(~framework) +\n  labs(\n    title = \"Digital Marketplace Sales Forecast by Framework\",\n    x = NULL, y = \"Spend\",\n    subtitle = \"80 & 95% Prediction Intervals\"\n  ) +\n  theme(\n    legend.position = \"none\",\n    axis.text.x = element_text(angle = 45, hjust = 1)\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/auto arima-1.png){width=100%}\n:::\n:::\n\n\nThe G-Cloud framework compromises three lots: Cloud Hosting, Cloud Software and Cloud Support.\n\nI previously combined `auto.arima` (from the forecast package) with functions from the sweep package, to create multiple forecasts in one shot. tsibble coupled fabletools handle this with the `key` set to the `lot` variable.\n\nAn alternative option is hierarchical time-series forecasting which models bottom-up, top-down or middle-out, and ensures the sum of the forecasts at the lower level sum to the top-level forecast. This approach has pros and cons and is not considered here.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngcloud_ts <- both |>\n  filter(framework == \"G-Cloud\") |> \n  summarise(spend = sum(spend), .by = c(date, lot)) |> \n  as_tsibble(key = lot, index = date)\n\ngc_ts <- gcloud_ts |>\n  model(ARIMA = ARIMA(spend, stepwise = TRUE, approximation = FALSE))\n\ngc_ts |> \n  glance() |>\n  select(-ar_roots, -ma_roots)\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|lot            |.model |    sigma2|   log_lik|      AIC|     AICc|      BIC|\n|:--------------|:------|---------:|---------:|--------:|--------:|--------:|\n|Cloud Hosting  |ARIMA  |  1.347179| -109.3173| 224.6346| 224.9982| 231.3801|\n|Cloud Software |ARIMA  |  2.275664| -107.5551| 221.1102| 221.5465| 227.3428|\n|Cloud Support  |ARIMA  | 18.606529| -212.6556| 435.3112| 436.2342| 446.6246|\n\n</div>\n:::\n\n```{.r .cell-code}\ngc_ts |> tidy()\n```\n\n::: {.cell-output-display}\n<div class=\"kable-table\">\n\n|lot            |.model |term     |   estimate| std.error|  statistic|   p.value|\n|:--------------|:------|:--------|----------:|---------:|----------:|---------:|\n|Cloud Hosting  |ARIMA  |ma1      | -0.8269314| 0.0765747| -10.799011| 0.0000000|\n|Cloud Hosting  |ARIMA  |constant |  0.1713346| 0.0258894|   6.617935| 0.0000000|\n|Cloud Software |ARIMA  |ma1      | -0.9981867| 0.1304426|  -7.652304| 0.0000000|\n|Cloud Software |ARIMA  |ma2      |  0.2242994| 0.1224834|   1.831264| 0.0721116|\n|Cloud Support  |ARIMA  |ma1      | -0.7044948| 0.0743797|  -9.471597| 0.0000000|\n|Cloud Support  |ARIMA  |sma1     |  0.3878660| 0.1458579|   2.659205| 0.0096735|\n|Cloud Support  |ARIMA  |sma2     |  0.7866476| 0.4284425|   1.836064| 0.0705352|\n|Cloud Support  |ARIMA  |constant |  0.7601155| 0.2889763|   2.630373| 0.0104520|\n\n</div>\n:::\n\n```{.r .cell-code}\nfcgc_ts <- gc_ts |>\n  forecast(h = \"2 years\") |> \n  mutate(`95%` = hilo(spend, 95), `80%` = hilo(spend, 80)) |> \n  unpack_hilo(c(\"95%\", \"80%\")) |> \n  rename(fc_spend = spend) |> \n  bind_rows(gcloud_ts)\n\nfcgc_ts |>\n  ggplot(aes(date, fill = lot)) +\n  geom_line(aes(y = spend), colour = cols[5]) +\n  geom_ribbon(aes(ymin = `95%_lower`, ymax = `95%_upper`),\n    fill = cols[1], colour = NA\n  ) +\n  geom_ribbon(aes(ymin = `80%_lower`, ymax = `80%_upper`),\n    fill = cols[2], colour = NA\n  ) +\n  geom_line(aes(y = .mean), colour = \"white\") +\n  scale_y_continuous(labels = label_dollar(prefix = \"£\", suffix = \"m\")) +\n  facet_wrap(~lot) +\n  labs(\n    title = \"G-Cloud Sales Forecast by Lot\",\n    x = NULL, y = \"Spend\",\n    subtitle = \"80 & 95% Prediction Intervals\"\n  ) +\n  theme(\n    legend.position = \"none\",\n    axis.text.x = element_text(angle = 45, hjust = 1)\n  )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/by lot-1.png){width=100%}\n:::\n:::\n\n\nSo ravens are not yet ready for forecasting with R. But then neither are 4-year-olds, are they?\n\n## R Toolbox\n\nSummarising below the packages and functions used in this post enables me to separately create a [toolbox visualisation](/project/box) summarising the usage of packages and functions across all posts.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nused_here()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"usedthese table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Package </th>\n   <th style=\"text-align:left;\"> Function </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> base </td>\n   <td style=\"text-align:left;\"> c[9], is.na[1], library[7], print[1], sum[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> clock </td>\n   <td style=\"text-align:left;\"> add_days[1], add_months[1], date_parse[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> conflicted </td>\n   <td style=\"text-align:left;\"> conflict_prefer_all[1], conflict_scout[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dplyr </td>\n   <td style=\"text-align:left;\"> bind_rows[3], filter[1], if_else[1], mutate[4], recode[1], rename[2], select[2], summarise[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> fable </td>\n   <td style=\"text-align:left;\"> ARIMA[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> fabletools </td>\n   <td style=\"text-align:left;\"> components[1], forecast[2], glance[2], hilo[4], model[3], tidy[2], unpack_hilo[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> feasts </td>\n   <td style=\"text-align:left;\"> STL[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ggplot2 </td>\n   <td style=\"text-align:left;\"> aes[11], autoplot[1], element_text[2], facet_wrap[2], geom_line[5], geom_ribbon[4], ggplot[3], labs[4], scale_colour_manual[2], scale_y_continuous[3], theme[2], theme_bw[1], theme_set[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> purrr </td>\n   <td style=\"text-align:left;\"> map[1], walk[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> readr </td>\n   <td style=\"text-align:left;\"> guess_encoding[1], locale[1], parse_number[1], read_csv[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> rlang </td>\n   <td style=\"text-align:left;\"> set_names[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> scales </td>\n   <td style=\"text-align:left;\"> label_dollar[3] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> stringr </td>\n   <td style=\"text-align:left;\"> coll[1], str_c[3], str_extract[1], str_remove[1], str_replace[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> tsibble </td>\n   <td style=\"text-align:left;\"> as_tsibble[2], yearmonth[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> usedthese </td>\n   <td style=\"text-align:left;\"> used_here[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> wesanderson </td>\n   <td style=\"text-align:left;\"> wes_palette[1] </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}