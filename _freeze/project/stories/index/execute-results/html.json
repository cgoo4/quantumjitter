{
  "hash": "2e7ee438a28823ca812fc28633c55b9c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Surprising Stories\"\ndate: \"2017-12-20\"\ncategories: [R, geospatial]\ndescription: \"A little interactive geospatial mapping and an unexpected find\"\nbibliography: references.bib\n---\n\n\n![](feature.gif){fig-alt=\"Young woman in a black dress, with a pony-tail moving in the gentle breeze, lies in a rowing boat in the middle of a still lake reading \\\"Carl's Blog\\\". A sandwich box sits nearby.\"}\n\nLate in 2017 I experimented with geospatial mapping techniques in R. The log file for my blog seemed like a good source of data. I thought it might appeal to a wider audience of one (including me).\n\nCombined with longitude and latitude data from MaxMind's GeoLite2, this offered a basis for analysis. Although less precise than the GeoIP2 database, this would be more than adequate for my purpose of getting to country and city level. I settled on the leaflet [@leaflet] package for visualisation given the interactivity and pleasing choice of aesthetics.\n\nThe results however were a little puzzling.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(conflicted)\nlibrary(tidyverse)\nconflict_prefer_all(\"dplyr\", quiet = TRUE)\nlibrary(rgeolocate)\nlibrary(R.utils)\nlibrary(leaflet)\nlibrary(sf)\nlibrary(htmlwidgets)\nlibrary(ggfoundry)\nlibrary(paletteer)\nlibrary(usedthese)\n\nconflict_scout()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_bw())\n\nn <- 5\npal_name <- \"wesanderson::Darjeeling2\"\n\npal <- paletteer_d(pal_name, n = n)\n\ndisplay_palette(fill = pal, n = n, pal_name = pal_name)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/theme-1.png){width=100%}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nworld_spdf <- read_sf(\"TM_WORLD_BORDERS_SIMPL-0.3.shp\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz\"\n\nfile_name <- basename(url)\n\ndownload.file(url, file_name)\n\ngunzip(file_name, overwrite = TRUE)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nstats <- read_csv(\"stats.csv\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nip_df <- map2(stats$IP, stats$Pages, \\(x, y) {\n  maxmind(\n    x,\n    \"GeoLite2-City.mmdb\",\n    c(\n      \"country_name\",\n      \"city_name\",\n      \"longitude\",\n      \"latitude\",\n      \"region_name\"\n    )\n  ) |>\n    mutate(IP = x) |>\n    rename(\n      country = country_name,\n      region = region_name,\n      city = city_name\n    ) |>\n    mutate(\n      Pages = y,\n      Views = case_when(\n        Pages < 500 ~ 1,\n        Pages < 1000 ~ 2,\n        Pages < 2000 ~ 3,\n        .default = 4\n      )\n    )\n}) |>\n  list_rbind()\n\nip_df <- ip_df |>\n  filter(!is.na(longitude) | !is.na(latitude)) |>\n  arrange(Pages)\n```\n:::\n\n\n\n\nThe concentration of page views in central London was of no immediate surprise as this was likely to be my site maintenance and blogging. What did strike me as odd though was the high concentration of page views in the centre of the US. More curious still, when I zoomed in on Kansas and found myself in the middle of the Cheney Reservoir.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncol_fac <-\n  colorFactor(as.character(pal[c(2:5)]),\n    domain = c(1, 2, 3, 4)\n  )\n\nmap1 <- leaflet(world_spdf) |> # World view\n  addProviderTiles(providers$CartoDB.Positron,\n    options = providerTileOptions(maxZoom = 21)\n  ) |>\n  setView(-30, 35, zoom = 2) |> # World view\n  addPolygons(\n    fillColor = pal[1],\n    stroke = TRUE,\n    fillOpacity = 1,\n    color = pal[5],\n    weight = 0.3,\n    highlight = highlightOptions(\n      weight = 3,\n      color = pal[3],\n      fillOpacity = 0.3,\n      bringToFront = FALSE\n    ),\n    label = world_spdf$NAME,\n    labelOptions = labelOptions(\n      style = list(\"font-weight\" = \"normal\"),\n      textsize = \"12px\"\n    )\n  ) |>\n  addCircleMarkers(\n    lng = ip_df$longitude,\n    lat = ip_df$latitude,\n    radius = ~ case_match(\n      ip_df$Views,\n      1 ~ 5,\n      2 ~ 10,\n      3 ~ 15,\n      .default = 20\n    ),\n    fillColor = ~ col_fac(ip_df$Views),\n    color = pal[5],\n    weight = 1,\n    fillOpacity = 0.7,\n    popup = str_c(\n      \"<b>\",\n      ip_df$city,\n      \"</b>\",\n      \"<br/>\",\n      ip_df$region,\n      \"<br/>\",\n      as.character(ip_df$Pages),\n      \" \",\n      \"page views\"\n    )\n  ) |>\n  addLegend(\n    colors = pal[c(2:5)],\n    labels = c(\"<500\", \"500+\", \"1,000+\", \"2,000+\"),\n    opacity = 1,\n    title = \"Page Views<br/>Oct-23 to Dec-31 2017\",\n    position = \"bottomleft\"\n  )\n```\n:::\n\n\n\n```{=html}\n<iframe seamless src=\"/project/stories/world.html\" width=\"100%\" height=\"500\"></iframe>\n```\n\nI imagined someone drifting in the expanse of water with laptop, flask of coffee and box of sandwiches, whiling away the hours absorbed in my blog. Perhaps not. How could such a small number of blog pages generate in excess of 2,000 page views in one spot in less than two months?\n\nThen I chanced upon a [BBC news article](https://www.bbc.co.uk/news/technology-37048521) from August 2016. When unable to locate IPs, MaxMind chose the geographical centre of the US as a default. This initially turned out to be a rented house in Kansas, which was rather unfortunate for the occupants, and brought upon them all kinds of unwanted attention.\n\nMaxMind subsequently changed its default centre points to be the middle of bodies of water. And this solved another puzzle. Some of the page views in London appeared to be in the middle of the River Thames.\n\n## R Toolbox\n\nSummarising below the packages and functions used in this post enables me to separately create a [toolbox visualisation](/project/box) summarising the usage of packages and functions across all posts.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nused_here()\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"usedthese table table-striped\" style=\"margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Package </th>\n   <th style=\"text-align:left;\"> Function </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> R.utils </td>\n   <td style=\"text-align:left;\"> gunzip[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> base </td>\n   <td style=\"text-align:left;\"> as.character[2], basename[1], c[5], getwd[1], is.na[2], library[10], list[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> conflicted </td>\n   <td style=\"text-align:left;\"> conflict_prefer_all[1], conflict_scout[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> dplyr </td>\n   <td style=\"text-align:left;\"> arrange[1], case_match[1], case_when[1], filter[1], if_else[2], mutate[3], rename[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ggfoundry </td>\n   <td style=\"text-align:left;\"> display_palette[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> ggplot2 </td>\n   <td style=\"text-align:left;\"> theme_bw[1], theme_set[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> htmlwidgets </td>\n   <td style=\"text-align:left;\"> saveWidget[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> leaflet </td>\n   <td style=\"text-align:left;\"> addCircleMarkers[1], addLegend[1], addPolygons[1], addProviderTiles[1], colorFactor[1], highlightOptions[1], labelOptions[1], leaflet[1], providerTileOptions[1], setView[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> paletteer </td>\n   <td style=\"text-align:left;\"> paletteer_d[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> purrr </td>\n   <td style=\"text-align:left;\"> list_rbind[1], map2[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> readr </td>\n   <td style=\"text-align:left;\"> read_csv[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> rgeolocate </td>\n   <td style=\"text-align:left;\"> maxmind[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> sf </td>\n   <td style=\"text-align:left;\"> read_sf[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> stringr </td>\n   <td style=\"text-align:left;\"> str_c[2] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> usedthese </td>\n   <td style=\"text-align:left;\"> used_here[1] </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> utils </td>\n   <td style=\"text-align:left;\"> download.file[2], unzip[1] </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}