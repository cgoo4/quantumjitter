{
  "hash": "b6fb9e853d117a31ceeadb34f53e057c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"ggfoundry 0.3.1\"\nauthor: \"Carl Goodwin\"\ndate: \"2024-07-07\"\ncategories: [R, package]\ndescription: \"Leafier and leaner\"\n---\n\n\n![](feature.png){fig-alt=\"A pair of balancing scales hold the lighter ggfoundry hex on the left scale and the heavier pair of leaves on the right scale.\"}\n\n[ggfoundry](https://github.com/cgoo4/ggfoundry) offers arbitrary colourable and fillable shapes for ggplot2. A showcase of examples, how it compares to other approaches and a list of available shapes, are all covered on the [package website](https://cgoo4.github.io/ggfoundry/).\n\nThe theme of ggfoundry 0.3.1:\n\n-   Outwardly focuses on adding fillable *leaves* to dendrograms; rotatable when using polar coordinates.\n\n-   Inwardly prioritises a *leaner* shipped package to provide more headroom for new shapes.\n\n## Leafier\n\nFillable leaves can enhance the visual impact of a dendrogram and help draw attention to particular clusters.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(conflicted)\nlibrary(tidyverse)\nconflict_prefer_all(\"dplyr\", quiet = TRUE)\nlibrary(scales)\nlibrary(ggfoundry)\nlibrary(ggdendro)\nlibrary(glue)\nlibrary(geomtextpath)\nlibrary(patchwork)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npal_name <- \"Custom Palette\"\n\npal <- c(\"#11424B\", \"#F8715F\", \"#EC974C\", \"#A2C26A\", \"#49786A\")\n\ndisplay_palette(pal, pal_name)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-2-1.png){width=100%}\n:::\n:::\n\n::: {.cell warnings='false'}\n\n```{.r .cell-code}\ndata <- hclust(dist(USArrests), \"ave\") |>\n  dendro_data(type = \"rectangle\")\n\ncluster <- hclust(dist(USArrests), \"ave\") |>\n  cutree(k = 2) |>\n  as_tibble(rownames = \"label\") |>\n  mutate(cluster = factor(value), .keep = \"unused\")\n\nnum_leaves <- nrow(data$labels)\noffset <- 15 # Degrees by which the first branch is rotated\nfrom <- 90 - offset # First text label\nby <- -(360 - (2 * offset)) / (num_leaves - 1) # Degrees between labels\n\nleaves <- data$labels |>\n  mutate(\n    angle = seq(from = from, by = by, length.out = num_leaves),\n    shape_angle = seq(from + 90, by = by, length.out = num_leaves),\n  ) |>\n  left_join(cluster, join_by(label))\n\nggplot() +\n  geom_segment(\n    aes(x = x, y = y, xend = xend, yend = yend),\n    data = segment(data)\n  ) +\n  geom_text(\n    aes(x = x, y = y, label = label, angle = angle),\n    size = 3, hjust = 0, nudge_y = 20, data = leaves\n  ) +\n  geom_casting(\n    aes(x, y, angle = shape_angle, group = x, fill = cluster, shape = cluster),\n    vjust = 0.7, size = 0.08, data = leaves\n  ) +\n  scale_y_reverse() +\n  scale_fill_manual(values = c(pal[2], pal[4])) +\n  scale_shape_manual(values = c(\"oak\", \"hibiscus\")) +\n  labs(title = \"Leafy Dendrogram\") +\n  coord_radial() +\n  theme_dendro() + \n  theme(\n    plot.title = element_text(hjust = 0.5),\n    legend.key.size = unit(2, \"line\"),\n    legend.position = \"top\"\n    )\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-3-1.png){width=100%}\n:::\n:::\n\n\nTwo leaf types are currently supported: *Hibiscus* and *oak*. More could be added if needed.\n\n## Leaner\n\nA reduction of \\>2MB in the shipped package size was achieved by:\n\n-   Moving supplementary documentation (with plots) from vignettes to articles;\n-   Switching snapshot tests from `png` files to ggplot layer data;\n-   Running the `svg`-to-`Picture` conversion at build time.\n\nConverting vignettes to articles is an easy win by moving them to a `vignettes/articles` sub-folder and ensuring `.Rbuildignore` contains `^vignettes/articles$` (it will already do so if `usethis::use_article` has been run). There's also the potential to remove `Suggests` from the `DESCRIPTION` file if packages are now only used in articles.\n\nSnapshot tests are a wonderful addition to testthat. The test takes a snapshot of something complex. The next time the test is run, if the output has changed, there's an option to accept the change (if intentional) or fix it (if unintentional). Switching to snapshots of `ggplot2::layer_data` is lighter and `png`-free.\n\nThe R Packages book has a section [understand when code is executed](https://r-pkgs.org/code.html#sec-code-when-executed) and advises carefully reviewing any code outside of a function. On-build does feel like the best time to make the `svg`-to-`Picture` conversion. Doing it outside of the package increases the shipped size. Doing it inside the plotting function affects performance. Doing it `.onLoad()` introduces a small (couple of seconds) delay in package load time.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npackage <- \"ggfoundry\"\n\nbuild_ignore <- read_lines(str_c(\"~/\", package, \"/.Rbuildignore\")) |>\n  str_remove(\"\\\\$\") |>\n  str_c(collapse = \"|\")\n\ndf <-\n  list.files(str_c(\"~/\", package), recursive = TRUE, full.names = TRUE) |>\n  map(file.info) |>\n  bind_rows() |>\n  as_tibble(rownames = \"path\") |>\n  select(path, size) |>\n  mutate(\n    path = str_extract(path, str_c(\"(?<=\", package, \"/).*\")),\n    type = if_else(str_detect(path, build_ignore), \"ignored\", \"shipped\"),\n  ) |>\n  separate_wider_delim(\n    path,\n    delim = \"/\",\n    names = c(\"lvl1\", \"lvl2\", \"lvl3\", \"lvl4\", \"lvl5\"),\n    too_few = \"align_start\",\n    too_many = \"drop\",\n    cols_remove = FALSE\n  )\n\nshipped_df <- df |>\n  mutate(across(starts_with(\"lvl\"), \\(x) case_when(\n    lvl3 %in% c(\"_snaps\") ~ str_c(lvl2, \"/\", lvl3),\n    lvl1 %in% c(\"inst\") ~ str_c(lvl1, \"/\", lvl2),\n    .default = x\n  ))) |>\n  summarise(size = sum(size), .by = c(lvl1, type)) |>\n  arrange(type, desc(size)) |>\n  filter(type == \"shipped\")\n\nship_size <- shipped_df |>\n  summarise(size = sum(size)) |>\n  pull()\n\ntheme_spiral <-\n  theme_void() +\n  theme(\n    plot.title = element_text(hjust = 0.5),\n    plot.subtitle = element_text(hjust = 0.5, margin = margin(0, 0, 30, 0)),\n    plot.margin = unit(c(1, 0, 0, 0), \"cm\"),\n    legend.position = \"none\"\n  )\n\np1 <- shipped_df |>\n  ggplot(aes(fct_reorder(lvl1, size), size)) +\n  geom_col(aes(fill = if_else(lvl1 == \"inst/extdata\", pal[4], pal[3]))) +\n  geom_textpath(\n    aes(label = lvl1), size = 2, \n    offset = unit(-10, \"pt\"), angle = -40, hjust = 1\n  ) +\n  geom_textpath(\n    aes(label = glue(\"{round(size / 1e3, 1)}\")),\n    vjust = 0, size = 3,\n  ) +\n  annotate(\"text\", 0.5, 0.5, label = \"KB\", vjust = 2.2) +\n  scale_y_log10() +\n  scale_fill_identity() +\n  labs(\n    title = glue(\"A leaner {package}\"),\n    subtitle = glue(\"{round(ship_size / 1e6, 2)}MB shipped\")\n  ) +\n  coord_radial(inner.radius = 0.1) +\n  theme_spiral\n\np2 <- df |>\n  filter(lvl2 == \"extdata\") |>\n  mutate(shape = str_extract(lvl3, \"(?<=-).*(?=_)\")) |>\n  summarise(size = sum(size), .by = shape) |>\n  ggplot(aes(fct_reorder(shape, size), size)) +\n  geom_col(fill = pal[4]) +\n  geom_textpath(\n    aes(label = shape), size = 2, \n    offset = unit(-10, \"pt\"), angle = -70, hjust = 1\n  ) +\n  geom_textpath(\n    aes(label = glue(\"{round(size / 1e3, 0)}\")),\n    vjust = 0, size = 2,\n  ) +\n  annotate(\"text\", 0.5, 0.5, label = \"KB\", vjust = 2.2) +\n  labs(\n    title = glue(\"{package} shapes\"), \n    subtitle = \"inst/extdata\"\n    ) +\n  coord_radial(inner.radius = 0.1) +\n  theme_spiral\n\np1 + p2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-5-1.png){width=100%}\n:::\n:::\n\n\nOverall, the 0.97MB shipped is comfortably within the \\<10MB [CRAN policy](https://cran.r-project.org/web/packages/policies.html#Source-packages) (5 data + 5 documentation) and leaves plenty of scope to grow.\n\nThe shapes are the biggest contributor: `inst/extdata` contains the 28 pairs of `svg` files (outline and fill). But each pair is relatively small, ranging from 5 to 66KB determined by shape complexity: The baby dendrogram being the most complex.\n\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}